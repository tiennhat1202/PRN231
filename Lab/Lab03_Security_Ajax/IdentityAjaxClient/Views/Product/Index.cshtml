@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<div class="container-fluid">
    <h2>Product List</h2>
    <table class="table table-sm table-striped table-bordered m-2">
        <thead>
            <tr>
                <th>ProductID</th>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Update</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal for Update -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="updateProductId">
                <div class="mb-3">
                    <label for="updateProductName" class="form-label">Product Name</label>
                    <input type="text" class="form-control" id="updateProductName">
                </div>
                <div class="mb-3">
                    <label for="updateQuantity" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="updateQuantity">
                </div>
                <div class="mb-3">
                    <label for="updateUnitPrice" class="form-label">Unit Price</label>
                    <input type="number" step="0.01" class="form-control" id="updateUnitPrice">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUpdate">Save Changes</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function(){
        ShowAllProducts();

        function ShowAllProducts(){
            $("table tbody").html("");
            $.ajax({
                url: "https://localhost:7067/api/Products",
                type: "get",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(result, status, xhr){
                    $.each(result, function(index, value){
                        $("tbody").append($("<tr>"));
                        appendElement = $("tbody tr").last();
                        appendElement.append($("<td>").html(value["productId"]));
                        appendElement.append($("<td>").html(value["productName"]));
                        appendElement.append($("<td>").html(value["unitsInStock"]));
                        appendElement.append($("<td>").html(value["unitPrice"]));
                      //  appendElement.append($("<td>").html("<a href=\"?id=" +value["productId"] + "\"><img src=\"icon/edit.png\" /></a> "));
                        appendElement.append($("<td>").html("<a href=\"#\" class=\"update\" data-id=\"" + value["productId"] + "\"><img src=\"icon/edit.png\" /></a>"));

                        appendElement.append($("<td>").html("<img class=\"delete\" src=\"icon/close.png\" />"));
                    });
                },
                error: function(xhr , status, error){
                    console.log(xhr)
                }
            });
        }
        
        $("table").on("click", "img.delete", function(){
            var productId = $(this).parents("tr").find("td:nth-child(1)").text();
            $.ajax({
                url: "https://localhost:7067/api/Products/" + productId,
                type: "delete",
                contentType: "application/json",
                success: function (result, status, xhr){
                    ShowAllProducts();
                },
                error: function(xhr, status, error){
                    console.log(xhr)
                }
            });
        });
        

        $("table").on("click", "a.update", function (e) {
            e.preventDefault();

            var productId = $(this).data("id");
            var productName = $(this).parents("tr").find("td:nth-child(2)").text();
            var quantity = $(this).parents("tr").find("td:nth-child(3)").text();
            var unitPrice = $(this).parents("tr").find("td:nth-child(4)").text();

            $("#updateProductId").val(productId);
            $("#updateProductName").val(productName);
            $("#updateQuantity").val(quantity);
            $("#updateUnitPrice").val(unitPrice);

            $("#updateModal").modal("show");
        });

        $("#saveUpdate").click(function () {
            var productId = $("#updateProductId").val();
            var newProductName = $("#updateProductName").val();
            var newQuantity = parseInt($("#updateQuantity").val());
            var newUnitPrice = parseFloat($("#updateUnitPrice").val());

            var updatedProduct = {
                productId: productId,
                productName: newProductName,
                unitsInStock: newQuantity,
                unitPrice: newUnitPrice
            };

            $.ajax({
                url: "https://localhost:7067/api/Products/" + productId,
                type: "put",
                data: JSON.stringify(updatedProduct),
                contentType: "application/json",
                success: function (result, status, xhr) {
                    $("#updateModal").modal("hide");
                    ShowAllProducts();
                },
                error: function (xhr, status, error) {
                    console.log(xhr);
                }
            });
        });

    });
</script>
